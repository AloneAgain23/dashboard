<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitor Geopol√≠tico ‚Äî Vigilancia Prospectiva</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap');

  :root {
    --bg: #080e1a;
    --surface: #0d1626;
    --surface2: #132035;
    --border: rgba(255,255,255,0.07);
    --text: #e8edf5;
    --muted: #6b7fa3;
    --accent: #3b82f6;
    --h1: #f59e0b;
    --h2: #06b6d4;
    --h3: #10b981;
    --danger: #ef4444;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ Grid de fondo ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    position: relative;
    z-index: 10;
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(59,130,246,0.06) 0%, transparent 100%);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header-left h1 {
    font-family: 'Syne', sans-serif;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .header-left h1 span {
    color: var(--accent);
  }

  .header-left p {
    color: var(--muted);
    font-size: 12px;
    margin-top: 4px;
    font-weight: 300;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .upload-area {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }

  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }

  .btn-ghost {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }

  /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
  .main {
    position: relative;
    z-index: 1;
    padding: 32px 40px;
    max-width: 1600px;
    margin: 0 auto;
  }

  /* ‚îÄ‚îÄ Stats cards ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    border-radius: 12px 12px 0 0;
  }

  .stat-card.total::before { background: var(--accent); }
  .stat-card.h1::before    { background: var(--h1); }
  .stat-card.h2::before    { background: var(--h2); }
  .stat-card.h3::before    { background: var(--h3); }

  .stat-card:hover { border-color: rgba(255,255,255,0.15); }

  .stat-label {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 36px;
    font-weight: 700;
    line-height: 1;
  }

  .stat-card.total .stat-value  { color: var(--text); }
  .stat-card.h1    .stat-value  { color: var(--h1); }
  .stat-card.h2    .stat-value  { color: var(--h2); }
  .stat-card.h3    .stat-value  { color: var(--h3); }

  .stat-sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
  }

  /* ‚îÄ‚îÄ Controles de filtro ‚îÄ‚îÄ */
  .controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 240px;
    max-width: 400px;
  }

  .search-wrap svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 10px 12px 10px 38px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    transition: border-color 0.2s;
    outline: none;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--muted); }

  .filter-chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .chip {
    padding: 7px 14px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--muted);
    transition: all 0.15s;
    user-select: none;
  }

  .chip:hover { color: var(--text); }
  .chip.active-all  { background: var(--accent);   border-color: var(--accent);   color: white; }
  .chip.active-h1   { background: var(--h1);       border-color: var(--h1);       color: #1a1a1a; }
  .chip.active-h2   { background: var(--h2);       border-color: var(--h2);       color: #0a1a1a; }
  .chip.active-h3   { background: var(--h3);       border-color: var(--h3);       color: #051a10; }

  .select-filter {
    padding: 9px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    outline: none;
  }

  .select-filter option { background: var(--surface); }

  /* ‚îÄ‚îÄ Tabla ‚îÄ‚îÄ */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .table-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .table-count {
    font-size: 12px;
    color: var(--muted);
  }

  .table-count strong { color: var(--text); }

  .table-scroll {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 600px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    position: sticky;
    top: 0;
    background: var(--surface2);
    padding: 12px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    z-index: 5;
  }

  thead th:hover { color: var(--text); }

  thead th.sort-asc::after  { content: ' ‚Üë'; color: var(--accent); }
  thead th.sort-desc::after { content: ' ‚Üì'; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
  }

  tbody tr:hover { background: var(--surface2); }

  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 12px 16px;
    vertical-align: top;
    line-height: 1.5;
  }

  .td-num {
    color: var(--muted);
    font-size: 11px;
    width: 40px;
    text-align: center;
  }

  .td-titular {
    max-width: 360px;
    font-weight: 500;
    color: var(--text);
  }

  .td-fecha {
    white-space: nowrap;
    color: var(--muted);
    font-size: 12px;
  }

  .td-fuente {
    white-space: nowrap;
    font-weight: 500;
  }

  .td-pais {
    white-space: nowrap;
    color: var(--muted);
    font-size: 12px;
  }

  .hyp-badge {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    font-family: 'Syne', sans-serif;
    letter-spacing: 0.3px;
    white-space: nowrap;
  }

  .hyp-h1 { background: rgba(245,158,11,0.15); color: var(--h1); border: 1px solid rgba(245,158,11,0.3); }
  .hyp-h2 { background: rgba(6,182,212,0.15);  color: var(--h2); border: 1px solid rgba(6,182,212,0.3);  }
  .hyp-h3 { background: rgba(16,185,129,0.15); color: var(--h3); border: 1px solid rgba(16,185,129,0.3); }

  .td-link a {
    color: var(--accent);
    text-decoration: none;
    font-size: 12px;
    opacity: 0.8;
    transition: opacity 0.15s;
  }
  .td-link a:hover { opacity: 1; text-decoration: underline; }

  .td-precursor {
    max-width: 280px;
    color: var(--muted);
    font-size: 12px;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--muted);
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state h3 {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    color: var(--text);
    margin-bottom: 8px;
  }

  .empty-state p { font-size: 13px; max-width: 400px; margin: 0 auto; }

  /* ‚îÄ‚îÄ Drop zone overlay ‚îÄ‚îÄ */
  .drop-overlay { display:none !important;
  /*
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(8,14,26,0.9);
    z-index: 100;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    border: 3px dashed var(--accent);
    border-radius: 16px;
    margin: 20px;
  }

  .drop-overlay.active { display: flex; }

  .drop-overlay h2 {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    color: var(--text);
  }

  .drop-overlay p { color: var(--muted); }

  /* ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ */
  .info-panel {
    background: var(--surface2);
    border: 1px solid rgba(59,130,246,0.2);
    border-left: 3px solid var(--accent);
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 24px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--muted);
  }

  .info-panel strong { color: var(--text); }

  /* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
  .legend {
    display: flex;
    gap: 20px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    flex: 1;
    min-width: 220px;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
  }

  .legend-dot-h1 { background: var(--h1); }
  .legend-dot-h2 { background: var(--h2); }
  .legend-dot-h3 { background: var(--h3); }

  .legend-text strong {
    display: block;
    font-size: 12px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    margin-bottom: 3px;
  }

  .legend-text span {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.4;
  }

  .legend-text strong.c-h1 { color: var(--h1); }
  .legend-text strong.c-h2 { color: var(--h2); }
  .legend-text strong.c-h3 { color: var(--h3); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* Responsive */
  @media (max-width: 768px) {
    header, .main { padding: 20px; }
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .controls { flex-direction: column; align-items: stretch; }
    .search-wrap { max-width: 100%; }
  }
</style>
</head>
<body>

<!-- Drop overlay -->
<div class="drop-overlay" id="dropOverlay">
  <div class="empty-icon">üìÇ</div>
  <h2>Dashboard listo</h2>
  <p>Datos embebidos en el archivo</p>
</div>

<!-- Header -->
<header>
  <div class="header-left">
    <h1>üåê Monitor <span>Geopol√≠tico</span></h1>
    <p>Vigilancia Prospectiva ‚Äî POLARIZACI√ìN GEOPOL√çTICA</p>
  </div>
  <div class="upload-area">
    <button class="btn btn-primary" onclick="exportCSV()">
      ‚¨á Exportar CSV
    </button>
  </div>
</header>

<!-- Main -->
<div class="main">

  <!-- Info -->
  <div class="info-panel" id="infoPanel">
    <strong>üöÄ C√≥mo usar este dashboard:</strong>
    Este dashboard viene con el JSON incluido en el archivo (inyectado autom√°ticamente). Luego podr√°s filtrar, buscar y explorar las noticias.
    </div>

  <!-- Stats -->
  <div class="stats-grid" id="statsGrid" style="display:none">
    <div class="stat-card total">
      <div class="stat-label">Total Noticias</div>
      <div class="stat-value" id="statTotal">0</div>
      <div class="stat-sub" id="statMeta">‚Äî</div>
    </div>
    <div class="stat-card h1">
      <div class="stat-label">H1 ‚Äî Presi√≥n</div>
      <div class="stat-value" id="statH1">0</div>
      <div class="stat-sub">Alineaci√≥n geopol√≠tica</div>
    </div>
    <div class="stat-card h2">
      <div class="stat-label">H2 ‚Äî Presencia</div>
      <div class="stat-value" id="statH2">0</div>
      <div class="stat-sub">China & Occidente</div>
    </div>
    <div class="stat-card h3">
      <div class="stat-label">H3 ‚Äî Nuevos Polos</div>
      <div class="stat-value" id="statH3">0</div>
      <div class="stat-sub">Reconfiguraci√≥n global</div>
    </div>
  </div>

  <!-- Leyenda -->
  <div class="legend" id="legend" style="display:none">
    <div class="legend-item">
      <div class="legend-dot legend-dot-h1"></div>
      <div class="legend-text">
        <strong class="c-h1">H1 ‚Äî Presi√≥n para Alinearse</strong>
        <span>Escalada militar Asia-Pac√≠fico ¬∑ Guerra comercial/tecnol√≥gica EE.UU.-China ¬∑ Aranceles ¬∑ Rivalidad en AL</span>
      </div>
    </div>
    <div class="legend-item">
      <div class="legend-dot legend-dot-h2"></div>
      <div class="legend-text">
        <strong class="c-h2">H2 ‚Äî Presencia China y Occidente</strong>
        <span>Competencia econ√≥mica en AL ¬∑ Foros multilaterales ¬∑ Diplomacia econ√≥mica ¬∑ Cooperaci√≥n selectiva</span>
      </div>
    </div>
    <div class="legend-item">
      <div class="legend-dot legend-dot-h3"></div>
      <div class="legend-text">
        <strong class="c-h3">H3 ‚Äî Emergencia de Nuevos Polos</strong>
        <span>BRICS y desdolarizaci√≥n ¬∑ Sur Global ¬∑ Alianzas India-Rusia ¬∑ Autonom√≠a estrat√©gica</span>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="controls" id="controls" style="display:none">
    <div class="search-wrap">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" class="search-input" id="searchInput" placeholder="Buscar en titulares, fuentes, pa√≠ses...">
    </div>
    <div class="filter-chips">
      <span class="chip active-all" data-filter="all" onclick="setFilter('all')">Todas</span>
      <span class="chip" data-filter="H1" onclick="setFilter('H1')">H1 Presi√≥n</span>
      <span class="chip" data-filter="H2" onclick="setFilter('H2')">H2 Presencia</span>
      <span class="chip" data-filter="H3" onclick="setFilter('H3')">H3 Nuevos Polos</span>
    </div>
    <select class="select-filter" id="sourceFilter" onchange="applyFilters()">
      <option value="">Todas las fuentes</option>
    </select>
    <select class="select-filter" id="countryFilter" onchange="applyFilters()">
      <option value="">Todos los pa√≠ses</option>
    </select>
  </div>

  <!-- Tabla -->
  <div class="table-wrap" id="tableWrap">
    <div class="table-header-bar">
      <div class="table-count" id="tableCount">
        <strong>0</strong> noticias visibles
      </div>
    </div>
    <div class="table-scroll">
      <table id="newsTable">
        <thead>
          <tr>
            <th class="td-num">#</th>
            <th onclick="sortTable('titular')">Hecho / Titular</th>
            <th onclick="sortTable('fecha')">Fecha</th>
            <th onclick="sortTable('fuente')">Fuente</th>
            <th onclick="sortTable('pais')">Pa√≠s</th>
            <th onclick="sortTable('hipotesis')">Hip√≥tesis</th>
            <th>Enlace</th>
            <th>Hecho Precursor</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">üì∞</div>
                <h3>Sin datos cargados</h3>
                <p>Este dashboard ya incluye los datos. Si no ves noticias, revisa que el JSON se haya inyectado correctamente.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
// JSON inyectado por el Action (placeholder a reemplazar)
const INYECTADO = __JSON_DATA__;

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allNews = [];
let filtered = [];
let currentFilter = 'all';
let sortKey = 'hipotesis';
let sortDir = 1;

// ‚îÄ‚îÄ Inicializar con JSON inyectado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initFromInjected(){
  try {
    const data = (typeof INYECTADO === 'string') ? JSON.parse(INYECTADO) : INYECTADO;
    const items = Array.isArray(data) ? data : (data.noticias || []);
    if (!items.length) {
      console.warn('No se encontraron noticias en el JSON inyectado.');
      return; // deja el empty state visible
    }
    processData(items, data.metadata || {});
  } catch (err) {
    console.error('Error al leer JSON inyectado:', err);
  }
})();

function processData(items, meta) {
  // Normalizar campos
  allNews = items.map((n, i) => ({
    id: i + 1,
    titular: n['Hecho/Titular'] || n.titular || '',
    fecha:   n['Fecha']         || n.fecha   || '',
    fuente:  n['Fuente']        || n.fuente  || '',
    pais:    n['Pa√≠s']          || n.pais    || '',
    enlace:  n['Enlace']        || n.enlace  || '',
    hipotesis: n['Hipotesis']   || n.hipotesis || '',
    precursor: n['Hecho precursor'] || n.hecho_precursor || '',
  }));

  // Actualizar stats
  document.getElementById('statsGrid').style.display = '';
  document.getElementById('legend').style.display = '';
  document.getElementById('controls').style.display = '';
  document.getElementById('infoPanel').style.display = 'none';

  document.getElementById('statTotal').textContent = allNews.length;
  document.getElementById('statH1').textContent = allNews.filter(n => n.hipotesis === 'H1').length;
  document.getElementById('statH2').textContent = allNews.filter(n => n.hipotesis === 'H2').length;
  document.getElementById('statH3').textContent = allNews.filter(n => n.hipotesis === 'H3').length;
  
  const range = meta.date_range || {};
  document.getElementById('statMeta').textContent = range.start
    ? `${range.start} ‚Üí ${range.end}` 
    : (meta.generated_at ? new Date(meta.generated_at).toLocaleDateString('es-PE') : '');

  // Poblar filtros
  const sources  = [...new Set(allNews.map(n => n.fuente).filter(Boolean))].sort();
  const countries = [...new Set(allNews.map(n => n.pais).filter(Boolean))].sort();
  
  const srcSel = document.getElementById('sourceFilter');
  srcSel.innerHTML = '<option value="">Todas las fuentes</option>';
  sources.forEach(s => srcSel.insertAdjacentHTML('beforeend', `<option>${s}</option>`));

  const ctrSel = document.getElementById('countryFilter');
  ctrSel.innerHTML = '<option value="">Todos los pa√≠ses</option>';
  countries.forEach(c => ctrSel.insertAdjacentHTML('beforeend', `<option>${c}</option>`));

  applyFilters();
}

// ‚îÄ‚îÄ Filtros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.chip').forEach(c => {
    c.className = 'chip';
    if (c.dataset.filter === f) c.classList.add('active-' + f.toLowerCase());
  });
  applyFilters();
}

function applyFilters() {
  const q       = document.getElementById('searchInput').value.toLowerCase();
  const srcF    = document.getElementById('sourceFilter').value;
  const ctrF    = document.getElementById('countryFilter').value;

  filtered = allNews.filter(n => {
    if (currentFilter !== 'all' && n.hipotesis !== currentFilter) return false;
    if (srcF && n.fuente !== srcF) return false;
    if (ctrF && n.pais !== ctrF) return false;
    if (q && !(`${n.titular} ${n.fuente} ${n.pais} ${n.precursor}`).toLowerCase().includes(q)) return false;
    return true;
  });

  // Ordenar
  filtered.sort((a, b) => {
    let av = a[sortKey] || '', bv = b[sortKey] || '';
    // Ordenar fecha
    if (sortKey === 'fecha') {
      av = parseDate(av); bv = parseDate(bv);
    }
    return av < bv ? -sortDir : av > bv ? sortDir : 0;
  });

  renderTable();
}

function parseDate(s) {
  const p = s.match(/(\d{2})-(\d{2})-(\d{4})/);
  return p ? `${p[3]}${p[2]}${p[1]}` : s;
}

document.getElementById('searchInput').addEventListener('input', applyFilters);

// ‚îÄ‚îÄ Ordenamiento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sortKeyMap = { titular:'titular', fecha:'fecha', fuente:'fuente', pais:'pais', hipotesis:'hipotesis' };

function sortTable(key) {
  if (sortKey === key) sortDir *= -1;
  else { sortKey = key; sortDir = 1; }
  
  document.querySelectorAll('thead th').forEach(th => {
    th.className = '';
    if (th.getAttribute('onclick') === `sortTable('${key}')`)
      th.className = sortDir === 1 ? 'sort-asc' : 'sort-desc';
  });
  applyFilters();
}

// ‚îÄ‚îÄ Render tabla ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable() {
  const tbody = document.getElementById('tableBody');
  document.getElementById('tableCount').innerHTML = `<strong>${filtered.length}</strong> noticias visibles`;

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state">
      <div class="empty-icon">üîç</div>
      <h3>Sin resultados</h3>
      <p>Prueba con otros t√©rminos o ajusta los filtros.</p>
    </div></td></tr>`;
    return;
  }

  const hypClass = { H1: 'hyp-h1', H2: 'hyp-h2', H3: 'hyp-h3' };
  const rows = filtered.map((n, i) => {
    const cls   = hypClass[n.hipotesis] || '';
    const host  = n.enlace ? (() => { try { return new URL(n.enlace).hostname.replace('www.',''); } catch { return '‚Üó Ver'; }})() : '';
    return `<tr onclick="openLink('${n.enlace}')">
      <td class="td-num">${i+1}</td>
      <td class="td-titular">${esc(n.titular)}</td>
      <td class="td-fecha">${esc(n.fecha)}</td>
      <td class="td-fuente">${esc(n.fuente)}</td>
      <td class="td-pais">${esc(n.pais)}</td>
      <td><span class="hyp-badge ${cls}">${esc(n.hipotesis)}</span></td>
      <td class="td-link">${n.enlace ? `<a href="${esc(n.enlace)}" target="_blank" onclick="event.stopPropagation()">üîó ${esc(host)}</a>` : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td class="td-precursor">${esc(n.precursor)}</td>
    </tr>`;
  });
  tbody.innerHTML = rows.join('');
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function openLink(url) {
  if (url) window.open(url, '_blank');
}

// ‚îÄ‚îÄ Exportar CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  if (!allNews.length) { alert('Carga primero un archivo JSON.'); return; }
  const data = filtered.length ? filtered : allNews;
  const cols = ['titular','fecha','fuente','pais','enlace','hipotesis','precursor'];
  const headers = ['Hecho/Titular','Fecha','Fuente','Pa√≠s','Enlace','Hipotesis','Hecho precursor'];
  
  const rows = [headers, ...data.map(n => cols.map(c => `"${(n[c]||'').replace(/"/g,'""')}"` ))];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `noticias_geopoliticas_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

</script>
</body>
</html>
